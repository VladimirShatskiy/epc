# Бот предназначен для загрузки фото/видео и документов и общения с клинентами сервиса

## Принцип работы
Бот является частью системы дилера по работе с заказ нарядами,
его задача на основании готовой базы с номерами заказ нарядов подгружать
под каждый из них требуемые материалы и отправлять фото и видео клиенту.
При этом используется весь функционал Телеграмма. т.е. все фотографии перед отправкой могут
быть отформатированы, помечены или на них выделены особые моменты на что 
стоит обратить внимание

Роли пользователей
1) - администратор, доступ при котором можно менять уровень доступа контактов из базы, + доступ сотрудника 

Функционал администратора:
имеет доступ к меню администратора:
* Смена уровня доступа:
	* Каждому пользователю можно назначить уровень доступа. По умолчанию, при подключении к боту устанавливается уровень 3 (клиент). 
	Администратор может сменить тип на 2 - сотрудник, 1 - администратор 4 - сотрудник службы заботы
* Смена имени пользователя. 
	* Для любого пользователя можно внести имя, сам бот имя у пользователя не запрашивает. Рекомендуется внести имена для всех сотрудников сервисного центра, т.к. именно от имени из базы, а не от личного имени в телеграмме, будет вестись общение с клиентами
* Просмотр протокола беседы. 
	* Вывод протокола беседы по номеру заказ наряда
* Просмотр протокола бесед не попавших в открытые заказ наряды. 
    * Например, клиент пишет сообщение по уже закрытому заказ наряду. данное сообщение попадает
      в отдельный протокол бесед. Или клиент ведет общение со службой заботы не по заказ наряду
* Смена уровня "активности" пользователя. 
	* Система не удаляет пользователей из списка. Доступ к "активности" не зависит от уровня доступа.
	Например, при увольнении сотрудника или отказе клиента от получения фото в бота можно установить данный признак.
	1 - пользователь активный, 
	2 - пользователь не активный (у него блокируется доступ к Боту, в том числе при попытке вновь к нему подключиться)

2) - доступ сотрудника, возможность загружать под заказ наряды фото и видео материалы

Функционал сотрудника:
команда "/ order" - выбрать заказ наряд используя календарь или часть номера заказ наряда
Так же можно просканировать заказ наряд по штрих коду или получить доступ к заказ наряду сфотографировав автомобиль с видимым гос номером. Выбрать тип действия (приемка, повреждение и т.д.)
Информация о выборе заказ наряда и типе действия будет закреплена в сообщении сверху.
После выбора, можно проводить фото и видео фиксацию. Все фотографии будут автоматически отосланы клиенту ( в случае подключения клиента к боту)
если клиент не подключен, сотрудник сервиса увидит соответующее сообщение.
так, же сотрудник сервиса может вести переписку с клиентом, находясь в его заказ наряде. Все что будет написано автоматически отправляется клиенту.	
При ответе клиента, сотрудник получит сообщение с номером заказ наряда по которому ответил клиент. Это позволит не запутаться с кем сотрудник общается. 
Для дальнейшего ответа , сотруднику необходимо будет вновь "провалиться" в заказ наряд по которому ответил клиент.

### ***Есть скрытый от клиента тип действия "Для сервисных нужд" при выборе данного действия фото и видео не отправляется клиенту, остается только на сервере дилера. Переписка при этом работает в обычном режиме

3) - доступ клиента

Функционал клиента:
ограничен возможностью принимать фото и видео отчеты сотрудников сервиса и текстовых сообщений от сотрудников. 
так-же клиент может отвечать на сообщения.
Дополнительно, через основное меню клиент может отправить сообщение сотруднику службы заботы. напримар при жалобе клиента


Для подключения клиента к боту необходимо послать клиенту sms или иное сообщение с ссылкой на бота.
Клиенту необходимо подключиться к боту, нажать на кнопку старт и согласиться с передачей контактной информации (номером телефона), после чего сможет получать все материалы.

Клиент будет получать все материалы из всех подпапок к заказ наряду за исключением папки Service, в эту папку можно загружать материалы для служебного пользования, клиенту они не пересылаются (под подпапками понимается стадии ремонта автомобиля: приемка автомобиля, кузовной ремонт, кузовные повреждения и т.д.)

4) - Сотрудник службы заботы о клиентах. 

Функционал сотрудника:
Сотрудник получает все сообщения направленные напрямую в отдел заботы и может вести переписку со всеми клиентами написавшими сообщения вне зависимости от наличия открытого заказ наряда на клиента.
Для идентификации клиента в сообщении получаемом сотрудников указывается номер телефона клиента. 
Так же предлагается ответить клиенту через бот, нажав кнопку ответа

Встроена дополнительная функция контроля общения с клиентом сотрудников. Если клиент в своем сообщении указывает любое слово из списка слов как пример,
ATTENTION_WORDS = ['плох', 'гряз', 'разочаров', 'не нрав','низко', 'дорог']
Сообщение от клиента с указанием номера заказ наряда уходит сразу администратору бота. Ьаким образом, администратор может понять по сообщению от клиента о необходимоти решения какого либо вопроса
Изменить список слов можно в файле database\attention_words.py обычным текстовым редактором, сохранив структуру списка


### Подготовка со стороны дилера
Для корректной работы бота необходимо выделить отдельную директорию в хранилище 
в которой будут содержаться папки с названиями номеров заказ нарядов. 
Для бота необходимо указать путь на директорию изменив в файле config.py
значение переменой BRANCH_PHOTO

В папку с заказ нарадом необходимо добавить файл conteте.txt с указанием номера заказ наряда, номером телефона клиента, штрих кода заказ наряда и гос номером автомобиля 
в формате словаря 
{
   "order": "a00017732",
   "barcode": "2800074366278382442612315631864110402",
   "phone": "+37888888808",
   "plate_number": "0124 МН-1"
}

При закрытии заказ наряда предусмотрено два варианта
1) удалить перенести папку из директории хранилища, в этом случае бот ее просто увидит и не сможет в нее добавить информацию. Во внутреней базе данных бота заказ наряд будет помечен
как закрытый
2) в конце названия папки указать специальный словом 'closed' при этом бот будет данную папку игнорировать. Данный ключ можно изменить в файле конфигурации

По каждому машинозаезду материалы могут загружаться в подпапки к заказ наряду. 
Изменить количество подпапок можно в файле config.py в переменной TYPE_ORDER (формат key:value)

Для смены наименования организации от имени которой клиент будет получать сообщения в телеграмме необходимо скорректировать имя переменной ORGANIZATION_NAME

Для распознования госномера необходимо установить программу tesseract дистрибудив можно взять по ссылке https://github.com/UB-Mannheim/tesseract/wiki 
так же прописать путь в config в переменную BRANCH_TESSERACT
пример
BRANCH_TESSERACT = r'C:\Program Files\Tesseract-OCR\tesseract.exe'

На текущий момент распознование номера настроено на форму номера "1234 AA - 5"
Для распознования номера не важно количество пробелов, наличие "-" и в какой раскладке клавиатуры написаны буквы (латиница/кирилица)


### Важно
При формировании календаря для выбора необходимого заказ наряда бот
смотрит дату создания папки с номером заказ наряда. Это стабильно работает на всех системах кроме linux
На Linux при изменении папки дата изменения приравнивается к дате создания, таким образом календарь бота
не будет корректно показывать созданные по датам заказ наряды


Схема работы бота клиент/сотрудник

Клиент. подключается к боту, подтверждает номер телеофна. При этом бот получает номер ID телеграмма клиента и его номер телефона

Сотруднк. Выбрав номер заказ наряда, бот читает номер телефона клиента по нему находит ID телеграмма клиента которому отправляются фотографии и сотрудник может ему написать в чат.
Основное для чего берется номер телефона клиента, это понять связь ID телеграмма с номером заказ наряда, эта связь находится через номер телефона

в БД бота отмечается сотрудник с каим ID телеграмма отправил сообщение клиенту. Если клиент ответить, то попадет на последнего сотрудника отправившего ему фото или ответившиму в чате








###### ***в случае вопросов готов прокомментировать shatskiy.v@inbox.ru***
